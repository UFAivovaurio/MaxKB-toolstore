# 飞书机器人推送工具

基于飞书Webhook API 封装的 Python 消息推送工具函数，支持文本消息发送、@成员提醒、全员通知等功能，适用于告警通知、自动化运维、业务消息推送等场景。

## 一、项目介绍

### 1.1 核心功能

- **文本消息推送**：向飞书群发送自定义文本消息，支持多行文本、特殊字符等内容。
- **@成员提醒**：支持 @指定成员（通过手机号获取用户 ID）或 @全体成员，确保重要消息及时触达。
- **动态用户 ID 获取**：通过飞书 API 自动将手机号转换为用户 ID，支持动态 @成员。
- **消息签名验证**：使用 HMAC-SHA256 算法生成签名，确保消息推送的安全性。
- **智能错误处理**：对 API 错误（如密钥无效、消息格式错误）、网络异常等进行分类捕获，输出清晰的错误提示。
- **会话管理优化**：使用 `requests.Session` 复用连接，提升推送性能。
- **简洁接口设计**：通过单一函数整合令牌获取、用户 ID 解析和消息推送，降低使用复杂度。

### 1.2 适用场景

- **系统告警通知**：服务器异常、接口报错、磁盘空间不足等告警信息实时推送到运维群。
- **自动化运维**：定时任务执行结果、脚本运行日志、数据备份状态等通知。
- **业务消息提醒**：订单状态变更、用户注册通知、数据统计报表等业务消息推送。
- **CI/CD 集成**：构建成功/失败通知、部署进度提醒、代码审查消息等。
- **日报周报推送**：定时推送团队工作总结、数据分析报告等。

---

## 二、环境准备

### 2.1 依赖库

该工具基于 Python 标准库与以下第三方库构建，依赖列表如下：

| 依赖库     | 版本要求  | 用途说明                     |
| ---------- | --------- | ---------------------------- |
| `requests` | ≥ 2.20.0  | 发送 HTTP POST 请求          |

### 2.2 安装依赖

通过 `pip` 安装 `requests` 库：

```bash
pip install requests
```

---

## 三、使用说明

### 3.1 获取飞书机器人配置

使用前需在飞书群聊中添加机器人并获取相关配置信息：

1. **创建群聊机器人**：
    - 在飞书 PC 端或移动端打开目标群聊。
    - 点击右上角 `...` → `群设置` → `群机器人` → `添加机器人`。
    - 为机器人命名（如“告警机器人”）并启用。

2. **配置安全设置**（推荐使用加签方式）：
    - 加签方式：勾选"加签"选项，系统会生成一个 secret 密钥
    - 自定义关键词：设置消息必须包含的关键词（可选）
    - IP 地址（段）：设置允许推送消息的 IP 白名单（可选）

3. **获取 Webhook Key 和 Secret**：
    - 添加成功后，系统会生成 Webhook 地址：
      - https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    - 其中 hook/ 后面的部分即为 webhook_key
    - 如果选择了加签方式，会同时得到一个 secret 密钥

4. **获取应用凭证**：
    *   创建飞书应用以获取 `app_id` 和 `app_secret`：
        *   登录飞书开放平台（[open.feishu.cn](https://open.feishu.cn/)）。
        *   创建应用并获取 `App ID` 和 `App Secret`。
        *   确保应用具有 `contact:users` 权限以查询用户 ID。
    *   参考 [飞书开放平台文档](https://open.feishu.cn/document/)。

> **注意**：飞书机器人存在频率限制（具体限制需参考飞书官方文档），建议控制推送频率以避免限流。

---

### 3.2 函数定义

```python
def feishubot(app_id, app_secret, mobiles, webhook_key, secret, push_message, is_at_all):
    """
    飞书机器人消息推送方法，整合获取用户ID和发送消息功能。

    Args:
        app_id (str): 飞书应用ID
        app_secret (str): 飞书应用密钥
        mobiles (str): 逗号分隔的手机号码（含国家代码，如+8613800138000）
        webhook_key (str): 飞书Webhook密钥
        secret (str): 飞书Webhook签名密钥
        push_message (str): 要发送的消息内容
        is_at_all (bool): 是否@全体成员

    Returns:
        str: 推送结果状态信息
    """
```

---

### 3.3 参数说明

#### 必需参数

| 参数名         | 类型  | 说明                 | 示例                    |
| :------------- |:----|:-------------------|:----------------------|
| `app_id`       | str | 飞书应用 ID            | `'xxxxxx'`            |
| `app_secret`   | str | 飞书应用密钥             | `'xxxxxx'`            |
| `webhook_key`  | str | 飞书机器人 Webhook 密钥   | `'xxxxxx'`            |
| `secret`       | str | 飞书 Webhook 签名密钥    | `'xxxxxx'`            |
| `push_message` | str | 要推送的文本消息内容         | `'服务器 CPU 使用率超过 80%'` |
| `is_at_all`    | int | 是否 @所有人（1 表示 @all） | `1` 或 `0`             |

#### 可选参数

| 参数名         | 类型 | 默认值       | 说明                        |
| :------------- | :--- |:----------|:--------------------------|
| `mobiles`      | str  | `""` | 要 @的成员手机号列表（需与飞书绑定的手机号一致） |

#### 参数组合说明

| 场景                 | `is_at_all` | `mobiles`                    | 效果                           |
| :------------------- |:------------|:-----------------------------| :----------------------------- |
| 普通消息             | `0`         | `""`                         | 仅发送消息，不 @任何人         |
| @全体成员            | `1`         | `""`                         | 消息会 @所有人                 |
| @指定成员            | `0`         | `"13800138000, 13900139000"` | 消息会 @这两个手机号对应的成员 |
| @全体 + @指定成员    | `1`         | `"13800138000"`               | 消息会 @所有人 |

---